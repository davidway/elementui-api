package com.blockchain.controller;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;

import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;
import org.springframework.http.MediaType;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.serializer.SerializerFeature;
import com.blockchain.VO.ConfigPropertiesForm;
import com.blockchain.VO.PhpSystemJsonContent;
import com.blockchain.exception.ServiceException;
import com.blockchain.exception.ParameterErrorException;
import com.blockchain.exception.StatusCode;
import com.blockchain.service.ConfigPropertiesService;
import com.blockchain.util.ResponseUtil;
import com.blockchain.util.TrustSDKUtil;
import com.blockchain.util.ValidatorUtil;
import com.tencent.trustsql.sdk.exception.TrustSDKException;
import com.wordnik.swagger.annotations.ApiImplicitParam;
import com.wordnik.swagger.annotations.ApiImplicitParams;
import com.wordnik.swagger.annotations.ApiOperation;

@Controller
@RequestMapping(value = "/configProperties")
public class ConfigController {
	Logger logger = Logger.getLogger(ConfigController.class);
	@Resource
	HttpServletResponse response;
	@Resource
	ConfigPropertiesService configPropertiesService;

	@ExceptionHandler(HttpMessageNotReadableException.class)  
	@ResponseBody  
	public PhpSystemJsonContent handleHttpMessageNotReadableException(  
	        HttpMessageNotReadableException ex) {  
		PhpSystemJsonContent response = new PhpSystemJsonContent();  
		response.setData("");
		response.setRetcode(StatusCode.PARAM_ERROR);
		response.setRetmsg("json格式错误，请检查是否为合法json");
	    return response;  
	}  
	
	
	@ResponseBody
	@RequestMapping(value = { "/add" }, method = RequestMethod.POST)
	@ApiOperation(value = "生成/修改 公共配置信息", httpMethod = "POST", response = ConfigPropertiesForm.class, consumes = "application/json",produces=MediaType.APPLICATION_JSON_VALUE)
	public void add(@Valid @RequestBody ConfigPropertiesForm configPropertiesForm, BindingResult bindingResult) throws TrustSDKException {

		PhpSystemJsonContent phpSystemJsonContent = new PhpSystemJsonContent();
		String jsonString = "";

		StringBuffer sb = new StringBuffer();
		try {
			TrustSDKUtil.checkPariKeyMatch(configPropertiesForm.getCreateUserPublicKey(), configPropertiesForm.getCreateUserPrivateKey());
			ValidatorUtil.validate(bindingResult);
		} catch (ParameterErrorException e1) {
			phpSystemJsonContent = phpSystemJsonContent.setParameterError(e1.getMessage());
			jsonString = JSON.toJSONString(phpSystemJsonContent);
			ResponseUtil.echo(response, jsonString);
			return;
		} catch (ServiceException e) {
			phpSystemJsonContent = phpSystemJsonContent.setParameterError(e.getMessage());
			jsonString = JSON.toJSONString(phpSystemJsonContent);
			ResponseUtil.echo(response, jsonString);
			return;
		}
		if (StringUtils.isNotBlank(sb)) {
			System.out.println(sb.toString());
		}
		try {
			configPropertiesService.add(configPropertiesForm);
		} catch (Exception e) {
			logger.error(e);
			phpSystemJsonContent.setRetmsg(e.getMessage());
			phpSystemJsonContent.setRetcode(StatusCode.SYSTEM_UNKOWN_ERROR);
			jsonString = JSON.toJSONString(phpSystemJsonContent);
			ResponseUtil.echo(response, jsonString);
			return;
		}
		configPropertiesForm = configPropertiesService.get();
		phpSystemJsonContent.setData(configPropertiesForm);
		jsonString = JSON.toJSONString(phpSystemJsonContent,SerializerFeature.WriteMapNullValue);
		ResponseUtil.echo(response, jsonString);
		return;
	}

	@ResponseBody
	@RequestMapping(value = { "/get" }, method = RequestMethod.POST)
	@ApiOperation(value = "获取公共配置信息", httpMethod = "POST", response = ConfigPropertiesForm.class, consumes = "application/json",produces=MediaType.APPLICATION_JSON_VALUE)
	public void get() {
		PhpSystemJsonContent phpSystemJsonContent = new PhpSystemJsonContent();
		ConfigPropertiesForm configPropertiesForm = configPropertiesService.get();
		phpSystemJsonContent.setData(configPropertiesForm);
		String jsonString = JSON.toJSONString(phpSystemJsonContent,SerializerFeature.WriteMapNullValue);
		ResponseUtil.echo(response, jsonString);
		return;

	}
}
